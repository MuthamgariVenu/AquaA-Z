<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aerator — Aquaculture A–Z</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { boxShadow: { soft:'0 12px 28px rgba(2,6,23,.08)' } } } }
  </script>

  <style>
    html { scroll-behavior:smooth; }
    body { background: linear-gradient(135deg,#e6f3ff 0%,#f0fbf7 100%); font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; color:#0f172a; }
    header { position:sticky; top:0; z-index:40; background:white; border-bottom:1px solid #e6eef6; }
    .container { max-width:1100px; margin:0 auto; padding:12px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem .9rem; border-radius:.75rem; font-weight:700; border:1px solid #e6eef6; background:white; cursor:pointer; }
    .btn.primary { background:#059669; color:#fff; border-color:#059669; }
    .card { border-radius:.75rem; background:white; border:1px solid #e6eef6; overflow:hidden; }
    .card-img { width:100%; height:120px; object-fit:cover; background:#f0f6fb; display:block; }
    .fans-pill { display:inline-block; padding:.12rem .5rem; border-radius:999px; font-weight:800; background:#ecfdf5; color:#065f46; margin-right:.5rem; }
    .hp-pill { display:inline-block; padding:.12rem .5rem; border-radius:999px; font-weight:700; background:#f0f9ff; color:#065f46; margin-left:8px; font-size:12px; }
    .recommended { outline:3px solid rgba(16,185,129,.14); box-shadow:0 8px 26px rgba(16,185,129,0.06); position:relative; }
    .recommend-badge { position:absolute; right:10px; top:10px; background:#059669; color:white; padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; }
    .hidden { display:none; }
    .toast { position:fixed; right:16px; bottom:24px; z-index:80; min-width:220px; background: rgba(2,6,23,0.9); color:white; padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.2); display:none; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:70; }
    .modal { width:94%; max-width:520px; background:white; border-radius:12px; padding:16px; box-shadow:0 18px 40px rgba(2,6,23,0.12); }
    .big-units { font-size:48px; font-weight:900; color:#065f46; }
    .mapping-title { font-weight:800; color:#065f46; margin-top:10px; }
    .mapping-row { margin-top:6px; color:#055a37; font-weight:700; }
    @media(min-width:768px){ .two-col { display:grid; grid-template-columns: 1fr 420px; gap:16px; } }
    @media(max-width:767px){ .card-img{height:140px;} .big-units{font-size:36px} }
  </style>
</head>
<body>

  <!-- Header: back + history + language selector -->
  <header>
    <div class="container flex items-center justify-between gap-3 py-3">
      <div class="flex items-center gap-3">
        <button id="backBtn" class="btn" onclick="history.back()">← <span id="lblBack">Back</span></button>
      </div>
      <div class="flex items-center gap-2">
        <a href="history.html" class="btn" id="lblHistory">History</a>
        <select id="langSel" class="btn" aria-label="Language">
          <option value="en">English</option>
          <option value="te">తెలుగు</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container pb-24">
    <section class="card p-4 mb-4">
      <h1 id="pageTitle" class="text-xl font-bold">Aerator</h1>
      <p id="pageDesc" class="mt-2 text-slate-600">Aerators help maintain oxygen levels in ponds — use the calculator to see how many devices you need.</p>
    </section>

    <!-- Calculator area -->
    <section id="calculatorArea" class="card p-4 mb-4">
      <h2 id="calcTitle" class="font-semibold mb-3">Aerator Calculator</h2>

      <label id="lblArea" class="text-xs font-medium">Pond area (acres)</label>
      <input id="acreInput" type="number" step="0.01" min="0.01" placeholder="eg. 0.5" class="mt-2 w-full rounded-lg border px-3 py-2" />

      <label id="lblDepth" class="text-xs font-medium mt-3 block">Average depth (ft)</label>
      <input id="depthFtInput" type="number" step="0.1" min="0.1" placeholder="eg. 4" class="mt-2 w-full rounded-lg border px-3 py-2" />

      <label id="lblPrawn" class="text-xs font-medium mt-3 block">Prawn size</label>
      <select id="prawnSize" class="mt-2 w-full rounded-lg border px-3 py-2">
        <option value="small">Small</option>
        <option value="medium">Medium (+20%)</option>
        <option value="large">Large (+40%)</option>
      </select>

      <div class="mt-4 flex gap-2">
        <button id="calcBtn" class="btn primary flex-1">Calculate</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>

      <!-- Result (only units emphasized) -->
      <div id="resultPanel" class="mt-4 hidden">
        <div id="unitsBox" class="p-4 rounded-lg" style="background:#ecfdf5;border:1px solid #bbf7d0">
          <div id="unitsLabel" class="text-sm text-slate-700">Units required</div>
          <div id="unitsBig" class="big-units mt-2">0 units</div>
          <div id="unitsNote" class="text-xs text-slate-600 mt-2">Devices measured as 'units' based on motor HP.</div>

          <!-- Aerator Mapping (only 2 entries) -->
          <div class="mapping-title" id="mappingTitle">Aerator Mapping</div>
          <div class="mapping-row" id="mapping2">2-fans → 1 HP = 1 unit</div>
          <div class="mapping-row" id="mapping4">4-fans → 2 HP = 2 units</div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="showNewBtn" class="btn">New</button>
          <button id="showOldBtn" class="btn">Old</button>
        </div>

        <!-- Equivalent-per-device (concise) -->
        <div id="equivSummary" class="mt-4 text-slate-700"></div>

        <div id="modelsSummary" class="mt-4 space-y-2"></div>
      </div>

      <p class="mt-4 text-xs text-slate-500" id="calcNote">Note: estimate only — verify product specs.</p>
    </section>

    <!-- Models area (hidden until user clicks New/Old) -->
    <section id="modelsArea" class="hidden mb-8">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <button id="tabNew" class="btn">New Aerators</button>
          <button id="tabOld" class="btn">Used Aerators</button>
        </div>
        <div>
          <button id="backToCalcBtn" class="btn">Back to calculator</button>
        </div>
      </div>

      <div id="modelsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- New models: data-units = units provided by one device (based on motor HP) -->
        <article class="card p-3" data-type="new" data-key="float-2" data-units="1" data-price="12000" data-flow="8000" data-fans="2" data-hp="1">
          <img class="card-img" src="assets/float-2.jpg" alt="2 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">2</span><span class="hp-pill">≈ 1 HP • 1 unit</span>
                <div class="font-bold model-name" data-name-en="Floating — 2 Fans" data-name-te="తేలే — 2 ఫ్యాన్స్">Floating — 2 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 8,000 L/h · Power: 150 W</div>
              </div>
              <div class="font-semibold">₹ 12,000</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="Surface floating; economical for small ponds." data-desc-te="పైన తేలే రకం; చిన్న చెరువుల కోసం సరసమైనది.">Surface floating; economical for small ponds.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="float-2" data-price="12000">Buy</button>
            </div>
          </div>
        </article>

        <article class="card p-3" data-type="new" data-key="float-4" data-units="2" data-price="22000" data-flow="16000" data-fans="4" data-hp="2">
          <img class="card-img" src="assets/float-4.jpg" alt="4 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">4</span><span class="hp-pill">≈ 2 HP • 2 units</span>
                <div class="font-bold model-name" data-name-en="Floating — 4 Fans" data-name-te="తేలే — 4 ఫ్యాన్స్">Floating — 4 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 16,000 L/h · Power: 300 W</div>
              </div>
              <div class="font-semibold">₹ 22,000</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="Good for medium ponds." data-desc-te="మధ్యమైన చెరువులకు ఉపయుక్తం.">Good for medium ponds.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="float-4" data-price="22000">Buy</button>
            </div>
          </div>
        </article>

        <article class="card p-3" data-type="new" data-key="float-6" data-units="3" data-price="32000" data-flow="24000" data-fans="6" data-hp="3">
          <img class="card-img" src="assets/float-6.jpg" alt="6 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">6</span><span class="hp-pill">≈ 3 HP • 3 units</span>
                <div class="font-bold model-name" data-name-en="Floating — 6 Fans" data-name-te="తేలే — 6 ఫ్యాన్స్">Floating — 6 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 24,000 L/h · Power: 450 W</div>
              </div>
              <div class="font-semibold">₹ 32,000</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="High circulation for larger ponds." data-desc-te="పెద్ద చెరువులకు అధిక సర్క్యులేషన్.">High circulation for larger ponds.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="float-6" data-price="32000">Buy</button>
            </div>
          </div>
        </article>

        <article class="card p-3" data-type="new" data-key="float-8" data-units="4" data-price="42000" data-flow="32000" data-fans="8" data-hp="4">
          <img class="card-img" src="assets/float-8.jpg" alt="8 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">8</span><span class="hp-pill">≈ 4 HP • 4 units</span>
                <div class="font-bold model-name" data-name-en="Floating — 8 Fans" data-name-te="తేలే — 8 ఫ్యాన్స్">Floating — 8 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 32,000 L/h · Power: 600 W</div>
              </div>
              <div class="font-semibold">₹ 42,000</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="Commercial ponds." data-desc-te="వాణిజ్య చెరువుల కోసమే.">Commercial ponds.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="float-8" data-price="42000">Buy</button>
            </div>
          </div>
        </article>

        <!-- used -->
        <article class="card p-3" data-type="old" data-key="used-2" data-units="1" data-price="7500" data-flow="7000" data-fans="2" data-hp="1" style="display:none">
          <img class="card-img" src="assets/used-2.jpg" alt="Used 2 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">2</span><span class="hp-pill">≈ 1 HP • 1 unit</span>
                <div class="font-bold model-name" data-name-en="Used — 2 Fans" data-name-te="రెండవ చేతి — 2 ఫ్యాన్స్">Used — 2 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 7,000 L/h · Power: 140 W</div>
              </div>
              <div class="font-semibold">₹ 7,500</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="Checked used unit." data-desc-te="సరి చూసిన రెండవ చేతి యూనిట్.">Checked used unit.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="used-2" data-price="7500">Buy</button>
            </div>
          </div>
        </article>

        <article class="card p-3" data-type="old" data-key="used-4" data-units="2" data-price="13500" data-flow="14000" data-fans="4" data-hp="2" style="display:none">
          <img class="card-img" src="assets/used-4.jpg" alt="Used 4 Fans" onerror="this.style.opacity=.6" />
          <div class="mt-3">
            <div class="flex items-start justify-between">
              <div>
                <span class="fans-pill">4</span><span class="hp-pill">≈ 2 HP • 2 units</span>
                <div class="font-bold model-name" data-name-en="Used — 4 Fans" data-name-te="రెండవ చేతి — 4 ఫ్యాన్స్">Used — 4 Fans</div>
                <div class="text-xs text-slate-500 mt-1">Flow: 14,000 L/h · Power: 280 W</div>
              </div>
              <div class="font-semibold">₹ 13,500</div>
            </div>
            <p class="mt-2 text-sm text-slate-600 model-desc" data-desc-en="Serviced used unit." data-desc-te="సర్వీస్ చేసిన రెండవ చేతి.">Serviced used unit.</p>
            <div class="mt-3 flex gap-2">
              <button class="btn detailsBtn flex-1">Details</button>
              <button class="btn primary buyBtn" data-key="used-4" data-price="13500">Buy</button>
            </div>
          </div>
        </article>

      </div>
    </section>

  </main>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal-backdrop">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="detailTitle">Model</h3>
        <button id="closeDetail" class="btn">✕</button>
      </div>
      <div id="detailSub" class="text-sm text-slate-600 mt-2"></div>
      <div id="detailBody" class="mt-3 text-sm"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="detailBuy" class="btn primary">Buy</button>
        <button id="detailClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Purchase Modal -->
  <div id="purchaseModal" class="modal-backdrop">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="purchaseTitle">Buy</h3>
        <button id="closePurchase" class="btn">✕</button>
      </div>
      <form id="purchaseForm" class="mt-3">
        <input type="hidden" id="purchaseModelKey" name="model" />
        <input type="hidden" id="purchasePrice" name="price" />
        <label class="text-xs">Name</label>
        <input id="buyerName" class="w-full rounded-lg border px-3 py-2 mt-1" required />
        <label class="text-xs mt-2">Phone</label>
        <input id="buyerPhone" class="w-full rounded-lg border px-3 py-2 mt-1" required />
        <label class="text-xs mt-2">Place</label>
        <input id="buyerPlace" class="w-full rounded-lg border px-3 py-2 mt-1" />
        <div class="mt-3 flex justify-end gap-2">
          <button class="btn primary" type="submit">Send request</button>
          <button id="cancelPurchaseBtn" type="button" class="btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const dict = {
      en: {
        Back:'Back', History:'History',
        pageTitle:'Aerator', pageDesc:'Aerators help maintain oxygen levels in ponds — use the calculator to see how many devices you need.',
        calcTitle:'Aerator Calculator', lblArea:'Pond area (acres)', lblDepth:'Average depth (ft)', lblPrawn:'Prawn size',
        small:'Small', medium:'Medium (+20%)', large:'Large (+40%)',
        calcBtn:'Calculate', resetBtn:'Reset',
        unitsLabel:'Units required', unitsNote:'Devices measured as units based on motor HP.',
        viewNew:'New', viewOld:'Old', backToCalc:'Back to calculator',
        details:'Details', buy:'Buy', calcNote:'Note: estimate only — verify product specs.',
        mapping2:'2-fans → 1 HP = 1 unit', mapping4:'4-fans → 2 HP = 2 units',
        equivLabel:'Equivalent:'
      },
      te: {
        Back:'వెనక్కి', History:'చరిత్ర',
        pageTitle:'ఎరేటర్', pageDesc:'ఎరేటర్లు చెరువుల్లో ఆక్సిజన్ స్థాయులను నిలుపుకునేందుకు ఉపయోగపడతాయి — కింద లెక్కింపు ద్వారా ఎంత అవసరం అనే తెలుసుకోండి.',
        calcTitle:'ఎరేటర్ కేల్క్యులేటర్', lblArea:'చెరువు ఉపరితలం (ఎకరాలు)', lblDepth:'సగటు లోతు (ఫుట్స్)', lblPrawn:'రొయ్యల పరుగు/కలవ',
        small:'చిన్న', medium:'మధ్యతరహా (+20%)', large:'పెద్ద (+40%)',
        calcBtn:'లెక్కించు', resetBtn:'రీసెట్',
        unitsLabel:'అవసరమైన యూనిట్లు', unitsNote:'ఉపకరణాలు మోటార్ HP ఆధారంగా యూనిట్లుగా కొలవబడ్డాయి.',
        viewNew:'కొత్త', viewOld:'పాత', backToCalc:'క్యాల్క్యులేటర్‌కు వెళ్ళు',
        details:'వివరాలు', buy:'కొనండి', calcNote:'గమనిక: ఇది అంచనా మాత్రమే — స్పెక్స్ నిర్ధారించండి.',
        mapping2:'2-fans → 1 HP = 1 يونిట్', mapping4:'4-fans → 2 HP = 2 يونిట్లు',
        equivLabel:'సమానంగా:'
      }
    };

    const $ = id => document.getElementById(id);
    const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    let lang = localStorage.getItem('lang') || 'en';

    function applyLang() {
      lang = localStorage.getItem('lang') || lang;
      const d = dict[lang];
      $('lblBack').textContent = d.Back;
      $('lblHistory').textContent = d.History;
      $('pageTitle').textContent = d.pageTitle;
      $('pageDesc').textContent = d.pageDesc;
      $('calcTitle').textContent = d.calcTitle;
      $('lblArea').textContent = d.lblArea;
      $('lblDepth').textContent = d.lblDepth;
      $('lblPrawn').textContent = d.lblPrawn;
      $('prawnSize').options[0].text = d.small;
      $('prawnSize').options[1].text = d.medium;
      $('prawnSize').options[2].text = d.large;
      $('calcBtn').textContent = d.calcBtn;
      $('resetBtn').textContent = d.resetBtn;
      $('unitsLabel').textContent = d.unitsLabel;
      $('unitsNote').textContent = d.unitsNote;
      $('showNewBtn').textContent = d.viewNew;
      $('showOldBtn').textContent = d.viewOld;
      $('calcNote').textContent = d.calcNote;
      $('tabNew').textContent = d.viewNew + ' Aerators';
      $('tabOld').textContent = d.viewOld + ' Aerators';
      $('mappingTitle').textContent = (lang==='te')? 'ఎరేటర్ మ్యాపింగ్' : 'Aerator Mapping';
      $('mapping2').textContent = d.mapping2;
      $('mapping4').textContent = d.mapping4;
      $('equivLabel') && ($('equivLabel').textContent = d.equivLabel);

      // model names & descriptions
      qsa('.model-name').forEach(el=>{
        const en = el.getAttribute('data-name-en') || el.textContent;
        const te = el.getAttribute('data-name-te') || en;
        el.textContent = (lang==='te')? te : en;
      });
      qsa('.model-desc').forEach(el=>{
        const en = el.getAttribute('data-desc-en') || '';
        const te = el.getAttribute('data-desc-te') || en;
        el.textContent = (lang==='te')? te : en;
      });
      qsa('.detailsBtn').forEach(b => b.textContent = d.details);
      qsa('.buyBtn').forEach(b => b.textContent = d.buy);
    }

    function showToast(txt,time=3000){
      const t = $('toast'); t.textContent=txt; t.style.display='block'; clearTimeout(t._t); t._t = setTimeout(()=> t.style.display='none', time);
    }

    // calcs
    const BASE_UNITS_PER_ACRE = 8;
    function calculateUnitsNeeded(acres, sizeKey) {
      const sizeMultipliers = { small:1.0, medium:1.2, large:1.4 };
      const m = sizeMultipliers[sizeKey] || 1.0;
      const units = acres * BASE_UNITS_PER_ACRE * m;
      return Math.max(0, units);
    }

    function computeDevicesFromUnits(unitsNeeded) {
      const cards = qsa('#modelsGrid article');
      const results = cards.map(card => {
        const key = card.getAttribute('data-key');
        const deviceUnits = parseFloat(card.getAttribute('data-units')) || 1;
        const price = parseFloat(card.getAttribute('data-price')) || 0;
        const devicesReq = Math.ceil(unitsNeeded / deviceUnits);
        return { key, card, deviceUnits, price, devicesReq, totalPrice: devicesReq * price, fans: card.getAttribute('data-fans') || '', hp: card.getAttribute('data-hp') || '' };
      });
      results.sort((a,b)=> a.totalPrice - b.totalPrice );
      return results;
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    document.addEventListener('DOMContentLoaded', ()=> {
      $('langSel').value = localStorage.getItem('lang') || lang;
      $('langSel').addEventListener('change', e=> { localStorage.setItem('lang', e.target.value); applyLang(); });
      applyLang();

      $('calcBtn').addEventListener('click', ()=> {
        const acres = parseFloat($('acreInput').value) || 0;
        const depthFt = parseFloat($('depthFtInput').value) || 0;
        const sizeKey = $('prawnSize').value || 'small';
        if (acres <= 0 || depthFt <= 0) { showToast((lang==='te')? 'దయచేసి సరైన విలువలు ఇవ్వండి.' : 'Please enter valid values.'); return; }

        const units = calculateUnitsNeeded(acres, sizeKey);
        $('unitsBig').textContent = Math.ceil(units).toLocaleString('en-IN') + ' units';

        // compute device counts and concise equivalent line
        const devices = computeDevicesFromUnits(units);
        const equivParts = devices.map(d => `${d.fans}-fans → ${d.devicesReq} device${d.devicesReq>1?'s':''}`);
        $('equivSummary').innerHTML = `<div style="font-weight:800;color:#065f46">${(lang==='te')? 'సమానంగా:' : 'Equivalent:'}</div><div style="margin-top:6px">${escapeHtml(equivParts.join(' • '))}</div>`;

        // render per-model summary with recommended first (cheapest)
        const summary = $('modelsSummary'); summary.innerHTML='';
        devices.forEach((r, idx)=>{
          const modelNameEl = r.card.querySelector('.model-name');
          const modelName = modelNameEl ? modelNameEl.textContent : r.key;
          const block = document.createElement('div');
          block.className = 'p-3 rounded-lg flex items-center justify-between';
          block.style.background = (idx===0) ? '#ecfdf5' : '#fbfbfb';
          block.innerHTML = `<div style="font-weight:800">${escapeHtml(r.fans)} — ${escapeHtml(modelName)}</div>
            <div style="text-align:right">
              <div style="font-weight:900;color:${idx===0?'#065f46':'#0f172a'};font-size:20px">${r.devicesReq.toLocaleString('en-IN')} <span style="font-size:14px;font-weight:700;color:#64748b">units</span></div>
              <div style="font-size:12px;color:#475569">(${r.totalPrice? '₹'+r.totalPrice.toLocaleString('en-IN') : ''})</div>
            </div>`;
          summary.appendChild(block);
        });

        $('resultPanel').classList.remove('hidden');
        window._lastCalc = { acres, depthFt, sizeKey, units, devices };
      });

      $('resetBtn').addEventListener('click', ()=> {
        $('acreInput').value=''; $('depthFtInput').value=''; $('prawnSize').value='small';
        $('resultPanel').classList.add('hidden'); $('modelsSummary').innerHTML=''; $('equivSummary').innerHTML=''; $('unitsBig').textContent='0 units';
        qsa('#modelsGrid article').forEach(a => { a.classList.remove('recommended'); const rb=a.querySelector('.recommend-badge'); if(rb) rb.remove(); });
      });

      $('showNewBtn').addEventListener('click', ()=> showModels('new'));
      $('showOldBtn').addEventListener('click', ()=> showModels('old'));
      $('tabNew').addEventListener('click', ()=> showModels('new'));
      $('tabOld').addEventListener('click', ()=> showModels('old'));
      $('backToCalcBtn').addEventListener('click', ()=> { $('modelsArea').classList.add('hidden'); window.scrollTo({top:0,behavior:'smooth'}); });

      $('modelsGrid').addEventListener('click', (ev)=> {
        const btn = ev.target.closest('button'); if (!btn) return;
        const article = btn.closest('article');
        if (btn.classList.contains('detailsBtn')) openDetailModal(article);
        else if (btn.classList.contains('buyBtn')) openPurchaseModal(article.getAttribute('data-key'), article.getAttribute('data-price'));
      });

      $('closeDetail').addEventListener('click', ()=> $('detailsModal').style.display='none');
      $('detailClose').addEventListener('click', ()=> $('detailsModal').style.display='none');
      $('detailBuy').addEventListener('click', ()=> {
        const k = $('detailTitle').getAttribute('data-key'); const p = $('detailTitle').getAttribute('data-price');
        $('detailsModal').style.display='none'; openPurchaseModal(k,p);
      });

      $('closePurchase').addEventListener('click', ()=> $('purchaseModal').style.display='none');
      $('cancelPurchaseBtn').addEventListener('click', ()=> $('purchaseModal').style.display='none');

      $('purchaseForm').addEventListener('submit', (e)=> {
        e.preventDefault();
        const name = $('buyerName').value.trim(); const phone = $('buyerPhone').value.trim();
        if (!name || !phone) { showToast((lang==='te')? 'దయచేసి పేరు మరియు ఫోన్ ఇవ్వండి.' : 'Please enter name and phone'); return; }
        const model = $('purchaseModelKey').value; const price = $('purchasePrice').value;
        const card = qsa(`#modelsGrid article[data-key="${model}"]`)[0];
        const modelName = card ? (card.querySelector('.model-name').textContent) : model;
        const en = `Purchase request: ${modelName} (${price? '₹'+price : ''}). Buyer: ${name}, Phone: ${phone}.`;
        const te = `కొనుగోలు అభ్యర్థన: ${modelName} (${price? '₹'+price : ''}). పేరు: ${name}, ఫోన్: ${phone}.`;
        window._lastPurchase = { en, te, model, price, name, phone, place: $('buyerPlace').value.trim() || '-' };
        $('purchaseModal').style.display='none';
        showToast((lang==='te')? 'మీ అభ్యర్థన అందుకుంది — మేము సంప్రదిస్తాము.' : 'Request received — we will contact you.');
      });

      function showModels(type) {
        $('modelsArea').classList.remove('hidden');
        qsa('#modelsGrid article').forEach(a=> a.style.display = (a.getAttribute('data-type')===type) ? '' : 'none');
        $('tabNew').classList.toggle('primary', type==='new');
        $('tabOld').classList.toggle('primary', type==='old');
        // highlight cheapest visible model if last calc exists
        qsa('#modelsGrid article').forEach(a => { a.classList.remove('recommended'); const rb=a.querySelector('.recommend-badge'); if(rb) rb.remove(); });
        const last = window._lastCalc;
        if (last && last.devices) {
          const visible = last.devices.find(d => d.card.getAttribute('data-type')===type);
          if (visible) {
            const c = visible.card; c.classList.add('recommended');
            const badge = document.createElement('div'); badge.className='recommend-badge'; badge.textContent = `${visible.devicesReq} ×`;
            c.appendChild(badge); setTimeout(()=> c.scrollIntoView({behavior:'smooth', block:'center'}),120);
          }
        }
      }

      function openDetailModal(article) {
        const name = article.querySelector('.model-name').textContent;
        const flow = article.getAttribute('data-flow') || '-';
        const price = article.getAttribute('data-price') || '-';
        const fans = article.getAttribute('data-fans') || '';
        const hp = article.getAttribute('data-hp') || '';
        $('detailTitle').textContent = name; $('detailTitle').setAttribute('data-key', article.getAttribute('data-key')); $('detailTitle').setAttribute('data-price', price);
        $('detailSub').textContent = `${fans}-fans • ≈ ${hp} HP • ₹ ${price}`;
        const desc = (lang==='te') ? (article.querySelector('.model-desc').getAttribute('data-desc-te') || article.querySelector('.model-desc').getAttribute('data-desc-en')) : article.querySelector('.model-desc').getAttribute('data-desc-en') || article.querySelector('.model-desc').getAttribute('data-desc-te');
        $('detailBody').innerHTML = `<div style="font-weight:700">${(lang==='te')? 'వివరణ' : 'Description'}</div><div style="margin-top:6px;color:#334155">${escapeHtml(desc)}</div>`;
        $('detailsModal').style.display='flex';
      }

      function openPurchaseModal(key, price) {
        $('purchaseModelKey').value = key; $('purchasePrice').value = price || ''; $('purchaseModal').style.display='flex';
      }

      // initial set mapping text (only two lines)
      $('mapping2').textContent = dict[lang].mapping2;
      $('mapping4').textContent = dict[lang].mapping4;
    });
  </script>
</body>
</html>
