<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aquaculture A‚ÄìZ ‚Ä¢ Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    /* Base visuals */
    html{scroll-behavior:smooth}
    body{background:linear-gradient(135deg,#dbeafe 0%,#e0f2fe 50%,#f0fdf4 100%);-webkit-font-smoothing:antialiased}
    html.dark body{background:linear-gradient(135deg,#0f172a 0%,#082f49 50%,#14532d 100%)}

    /* header/nav/buttons */
    .navbtn{border:1px solid rgb(226,232,240);padding:.55rem .9rem;border-radius:.75rem;background:#fff;text-align:center;font-weight:700;font-size:1rem;white-space:nowrap;}
    @media (min-width:640px){ .navbtn{font-size:.95rem;padding:.6rem 1rem} }
    .dark .navbtn{background:#0b1220;border-color:#1f2937}

    /* ticker - removed mask to avoid clipping; ensure good contrast in dark */
    .ticker{overflow:hidden}
    .ticker-track{display:flex;gap:24px;white-space:nowrap;min-width:max-content;animation:ticker 35s linear infinite}
    @keyframes ticker{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    @media (max-width:640px){ .ticker-track{gap:16px;animation-duration:45s} }
    @keyframes blink{0%,100%{opacity:1;background-color:#facc15;color:#111827}50%{opacity:1;background-color:#dc2626;color:#fff}}
    .blink{animation:blink 1.2s infinite}

    /* promos */
    .promo-dot{height:.5rem;width:.5rem;border-radius:9999px;border:1px solid currentColor;opacity:.5}
    .promo-dot.active{opacity:1;background:currentColor}
    .promo-slide{display:none}
    .promo-slide.active{display:block}

    /* theme toggle icons */
    #themeToggle { display:flex; align-items:center; justify-content:center; gap:8px; border-radius:9999px; padding:.35rem .6rem; background:transparent; cursor:pointer; border:1px solid rgba(148,163,184,0.12); }
    #themeToggle .icon-sun, #themeToggle .icon-moon { display:inline-flex; width:18px; height:18px; line-height:1; }
    html.dark #themeToggle .icon-sun { display:inline-flex; }
    html.dark #themeToggle .icon-moon { display:none; }
    html:not(.dark) #themeToggle .icon-sun { display:none; }
    html:not(.dark) #themeToggle .icon-moon { display:inline-flex; }

    /* chat */
    .chat-btn {
      position: fixed;
      right: 16px;
      bottom: calc(18px + env(safe-area-inset-bottom));
      width: 56px; height: 56px; border-radius: 50%;
      background: #0b6b6b; color: #fff; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 18px rgba(11,107,107,0.18); border: none; z-index: 1200; font-size: 20px;
      transition: transform .18s ease, bottom .18s ease;
    }
    html.dark .chat-btn { background:#0b9a9a; color:#012; }

    .chat-panel {
      position: fixed;
      right: 14px;
      bottom: calc(90px + env(safe-area-inset-bottom));
      width: 92%;
      max-width: 380px;
      height: 56vh;
      max-height: 72vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      display: none; flex-direction: column; overflow: hidden; z-index: 1250;
      color: #111;
    }
    .chat-panel.open { display:flex; }
    html.dark .chat-panel { background:#071824; color:#e6eef3; box-shadow: 0 10px 30px rgba(2,6,23,0.5); }

    .chat-header { padding: 12px; border-bottom: 1px solid #eee; display:flex;align-items:center;justify-content:space-between; }
    html.dark .chat-header { border-color: rgba(255,255,255,0.06); }
    .chat-title { font-weight:600; font-size:15px; color:#0b5b5b; }
    html.dark .chat-title { color:#dff3ef; }

    .chat-messages { flex:1; padding:12px; overflow:auto; display:flex;flex-direction:column; gap:8px; background:#fbfbfb; }
    html.dark .chat-messages { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }

    .msg { max-width:78%; padding:8px 10px; border-radius:10px; font-size:14px; word-break:break-word; }
    .msg.user { align-self:flex-end; background:#0b6b6b; color:#fff; border-bottom-right-radius:4px; }
    html.dark .msg.user { background:#0b9a9a; color:#012; }
    .msg.bot { align-self:flex-start; background:#fff; color:#111; border:1px solid #eee; }
    html.dark .msg.bot { background: rgba(255,255,255,0.03); color:#e6eef3; border: 1px solid rgba(255,255,255,0.04); }
    .reply-en { font-weight:700; margin-bottom:4px; color:#0b3b3b; }
    html.dark .reply-en { color:#dff3ef; }
    .reply-te { color:#475569; font-size:13px; opacity:0.95; }
    html.dark .reply-te { color:#bfe8dc; opacity:0.95; }

    .chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; align-items:center; }
    html.dark .chat-input { border-top-color: rgba(255,255,255,0.04); }
    .chat-input input { flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px; background:#fff; color:#111; min-height:44px; }
    html.dark .chat-input input { background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.06); color:#e6eef3; }
    .chat-input input::placeholder { color: #9aa3ad; }
    html.dark .chat-input input::placeholder { color: #95b5ac; opacity:0.95; }
    .chat-input button { padding:10px 14px;border-radius:8px;border:none;background:#0b6b6b;color:#fff;font-weight:600; min-width:64px; min-height:44px; }
    html.dark .chat-input button { background:#0b9a9a; color:#012; font-weight:700; }

    @media(max-width:420px){
      .chat-panel{ right:8px; left:8px; max-width:none; width: calc(100% - 16px); bottom: calc(140px + env(safe-area-inset-bottom)); height: 50vh; max-height: 70vh; }
      .chat-input { padding: 8px; gap:6px; }
      .chat-input input { padding:9px; border-radius:10px; font-size:15px; }
      .chat-btn { right: 12px; bottom: calc(110px + env(safe-area-inset-bottom)); transform: translateY(0); }
    }

    /* FLASH/TICKER: ensure very good contrast in dark mode */
    .ticker-track > div { color: #0b1f2a; }
    html.dark .ticker-track > div { color: #e6f6f0; }
    .ticker-track .blink { background: #facc15; color: #111; }
    html.dark .ticker-track .blink { background: #f59e0b; color:#04101a; }

    .ticker, .ticker-track { touch-action: pan-y; -webkit-user-select: text; user-select: text; }

    .flash-section h3 { color: #0b1f2a; }
    html.dark .flash-section h3 { color: #e6f6f0; }

    /* Snapshot select alignment helper:
       shift the type-select so its left edge lines up with the table's Price column.
       Adjust the margin-left until visually aligned; tuned for most common layouts.
    */
    .snapshot-controls { display:flex; align-items:center; gap:0.75rem; }
    .snapshot-controls .type-label { min-width:40px; color: #334155; font-weight:600; }
    .type-select { padding:.35rem .5rem; border-radius:.35rem; border:1px solid #d1d5db; background:#fff; }
    html.dark .type-select { background:#0b1220; border-color: #1f2937; color: #e6eef3; }

    /* this sets a left margin to move select towards center (desktop) */
    @media(min-width:1024px){
      /* tweak this value if you want slightly different alignment */
      .type-select { margin-left: 3.2rem; }
    }
    @media(max-width:1023px){
      .type-select { margin-left: 0; }
    }

    /* defensive: ensure modules are visible on desktop */
    .module { display: block !important; visibility: visible !important; opacity: 1 !important; }

    /* small table visuals */
    table thead th { font-weight:600; }
    table td, table th { padding-left:0.6rem; padding-right:1rem; padding-top:.5rem; padding-bottom:.5rem; }
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center">
      <div class="h-9 w-9 mr-1 relative">
        <img src="assets/logo.png" alt="Logo" class="h-9 w-9 object-contain block dark:hidden">
        <img src="assets/logo-dark.png" alt="Logo" class="h-9 w-9 object-contain hidden dark:block">
      </div>

      <h1 class="text-xl font-bold flex-1">Aquaa A‚ÄìZ</h1>

      <!-- Right-side controls (language + theme) -->
      <div class="flex items-center gap-2">
        <label for="langSel" class="text-sm text-slate-600 dark:text-slate-300 select-none hidden sm:inline">Ln</label>
        <select id="langSel" class="text-sm border rounded-md px-2 py-1 dark:bg-slate-900 dark:border-slate-700">
          <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
          <option value="en">English</option>
        </select>

        <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800" aria-label="Toggle theme">
          <span class="icon-moon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
          <span class="icon-sun" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke-width="1.6"/></svg></span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4 pb-36 sm:pb-4">
    <!-- MOBILE nav buttons -->
    <div class="flex sm:hidden gap-2 justify-around">
      <a href="harvest.html" class="navbtn flex-1 text-center">üöö <span data-i18n="t_harvest">Harvest</span></a>
      <a href="seeds.html" class="navbtn flex-1 text-center">ü¶ê <span data-i18n="t_seeds">Seeds</span></a>
      <a href="vendors.html" class="navbtn flex-1 text-center">üè™ <span data-i18n="t_dealers">Dealers</span></a>
    </div>

    <!-- Flash News (module) -->
    <section class="flash-section module rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">üì∞ <span data-i18n="flash_news">Flash News</span></h3>
        <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200">Live</span>
      </div>
      <div class="mt-3 ticker" aria-hidden="false"><div id="newsTrackTop" class="ticker-track" role="list"></div></div>
      <p class="text-xs text-slate-500 mt-2"><span data-i18n="updated">Updated</span>: <span id="newsUpdatedTop">‚Äî</span></p>
    </section>

    <!-- Rates + Promotions (modules) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Rates -->
      <div class="module rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold" data-i18n="snapshot">‡∞≤‡±à‡∞µ‡±ç ‡∞∏‡±ç‡∞®‡∞æ‡∞™‡±ç‚Äå‡∞∑‡∞æ‡∞ü‡±ç</h3>
          <p class="text-xs text-slate-500"><span data-i18n="updated">‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç</span>: <span id="updatedAt">‚Äî</span></p>
        </div>

        <!-- snapshot controls: label + select. select moved right via css to align with table -->
        <div class="mt-3 snapshot-controls">
          <label class="type-label" for="prawnType" data-i18n="lbl_type">‡∞∞‡∞ï‡∞Ç</label>
          <select id="prawnType" class="type-select" aria-label="Type select"></select>
        </div>

        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm" id="ratesTable">
            <thead>
              <tr class="border-b dark:border-slate-800 text-slate-500">
                <th class="text-left py-2 pr-4" data-i18n="th_count">‡∞ï‡±å‡∞Ç‡∞ü‡±ç</th>
                <th class="text-left py-2 pr-4" data-i18n="th_price">‡∞ß‡∞∞ (‚Çπ/kg)</th>
                <th class="text-left py-2 pr-4" data-i18n="th_change">‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Promotions -->
      <div class="module rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">üì£ <span data-i18n="promotions_title">‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã‡∞∑‡∞®‡±ç‡∞∏‡±ç</span></h3>
        </div>
        <div id="promoSlider" class="relative mt-3">
          <div id="promoTrack" class="overflow-hidden rounded-xl"></div>
          <div id="promoDots" class="mt-3 flex gap-2"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="fixed bottom-0 inset-x-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-around py-2 z-40 sm:hidden"
       style="padding-bottom: env(safe-area-inset-bottom);">
    <a href="index.html" class="flex flex-col items-center text-base font-semibold">
      <span>üè†</span><span data-i18n="m_home">Home</span>
    </a>
    <a href="history.html" class="flex flex-col items-center text-base font-semibold">
      <span>üïò</span><span data-i18n="m_history">History</span>
    </a>
    <a href="aerator.html" class="flex flex-col items-center text-base font-semibold">
      <span>‚öôÔ∏è</span><span data-i18n="m_aerator">Aerator</span>
    </a>
  </nav>

  <!-- Chat -->
  <button class="chat-btn" id="openChat" aria-label="Open chat">üí¨</button>

  <div class="chat-panel" id="chatPanel" role="dialog" aria-label="Chat with Aqua A-Z" aria-hidden="true">
    <div class="chat-header">
      <div class="chat-title" id="chatTitle" data-i18n="chat_title">Help & Chat</div>
      <button id="closeChat" aria-label="Close chat" style="background:none;border:none;font-size:18px;padding:6px;cursor:pointer">‚úï</button>
    </div>

    <div class="chat-messages" id="chatMessages" aria-live="polite"></div>

    <div class="chat-input" role="form" aria-label="Chat input">
      <input id="chatInput" type="text" placeholder="Type a message..." aria-label="Type a message" />
      <button id="sendBtn" aria-label="Send message">Send</button>
    </div>
  </div>

  <script>
    // Admin contact (you provided)
    const ADMIN_CONTACT_PHONE = '+91 9963643062';
    const ADMIN_CONTACT_EMAIL = 'mvenu139@gmail.com';

    // small helper
    const $id = s => document.getElementById(s);

    // global app data for chat
    window.APP_DATA = { rates: [], news: [], promos: [] };

    async function loadCSV(url){
      try{
        const res = await fetch(url,{cache:'no-store'});
        if(!res.ok) throw 0;
        const txt = await res.text();
        const lines = txt.trim().split(/\r?\n/);
        if(lines.length < 2) return [];
        const headers = lines[0].split(',').map(h=>h.trim());
        return lines.slice(1).map(line=>{
          const vals = line.split(',');
          const o = {};
          headers.forEach((h,i)=>o[h]= (vals[i]||'').trim());
          return o;
        });
      }catch(e){ return []; }
    }

    // i18n dictionary
    window.dict = {
      en:{
        snapshot:"Live Snapshot",updated:"Updated",lbl_type:"Type",th_count:"Count",th_price:"Price (‚Çπ/kg)",th_change:"Change",
        promotions_title:"Promotions",m_aerator:"Aerator",m_home:"Home",m_history:"History",t_harvest:"Harvest",t_seeds:"Seeds",t_dealers:"Dealers",
        flash_news:"Flash News", chat_title:"Help & Chat", chat_greeting:"Hi! How can I help you today?", chat_placeholder:"Type a message...",
        chat_reply_default:"Sorry, I cannot perform that now; but I can help. Please give more details.",
        chat_reply_contact:"You can reach admin at %PHONE% or %EMAIL%.",
        chat_reply_aerator:"What details about aerators do you need? Model, capacity, or services?",
        chat_reply_history:"History: latest updates are managed by site admin and shown here when available."
      },
      te:{
        snapshot:"‡∞≤‡±à‡∞µ‡±ç ‡∞∏‡±ç‡∞®‡∞æ‡∞™‡±ç‚Äå‡∞∑‡∞æ‡∞ü‡±ç",updated:"‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç",lbl_type:"‡∞∞‡∞ï‡∞Ç",th_count:"‡∞ï‡±å‡∞Ç‡∞ü‡±ç",th_price:"‡∞ß‡∞∞ (‚Çπ/kg)",th_change:"‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å",
        promotions_title:"‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã‡∞∑‡∞®‡±ç‡∞∏‡±ç",m_aerator:"‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç",m_home:"‡∞π‡±ã‡∞Æ‡±ç",m_history:"‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",t_harvest:"‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç",t_seeds:"‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç",t_dealers:"‡∞µ‡±Ü‡∞Ç‡∞°‡∞∞‡±ç‡∞≤‡±Å",
        flash_news:"‡∞§‡∞æ‡∞ú‡∞æ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§", chat_title:"‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç & ‡∞ö‡∞æ‡∞ü‡±ç", chat_greeting:"‡∞π‡∞æ‡∞Ø‡±ç! ‡∞®‡±á‡∞®‡±Å ‡∞Æ‡±Ä‡∞ï‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å?", chat_placeholder:"‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø...",
        chat_reply_default:"‡∞ï‡±ç‡∞∑‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø, ‡∞®‡±á‡∞®‡±Å ‡∞¶‡±Ä‡∞®‡±ç‡∞®‡∞ø ‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞ö‡±á‡∞Ø‡∞≤‡±á‡∞®‡±Å; ‡∞ï‡∞æ‡∞®‡±Ä ‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞π‡∞æ‡∞Ø‡∞™‡∞°‡∞ó‡∞≤‡∞®‡±Å. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø.",
        chat_reply_contact:"‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞æ‡∞π‡∞ï‡±Å‡∞®‡∞ø‡∞®‡∞ø ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø %PHONE% ‡∞≤‡±á‡∞¶‡∞æ %EMAIL%.",
        chat_reply_aerator:"‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç‡∞≤ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞è‡∞Æ‡∞ø ‡∞§‡±Ü‡∞≤‡±Å‡∞∏‡±Å‡∞ï‡±ã‡∞µ‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å? ‡∞Æ‡±ã‡∞°‡∞≤‡±ç, ‡∞∏‡∞æ‡∞Æ‡∞∞‡±ç‡∞•‡±ç‡∞Ø‡∞Ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞∏‡±á‡∞µ‡∞≤‡±Å?",
        chat_reply_history:"‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞: ‡∞§‡∞æ‡∞ú‡∞æ ‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç‡∞∏‡±ç ‡∞∏‡±à‡∞ü‡±ç ‡∞Ö‡∞°‡±ç‡∞Æ‡∞ø‡∞®‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ö‡±Ç‡∞™‡∞¨‡∞°‡∞§‡∞æ‡∞Ø‡∞ø."
      }
    };

    function applyI18n(){
      const lang = localStorage.getItem('lang') || 'te';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.dataset.i18n;
        if(window.dict[lang] && window.dict[lang][k]) el.textContent = window.dict[lang][k];
      });
      if($id('chatInput')) $id('chatInput').placeholder = window.dict[lang].chat_placeholder || '';
      if($id('chatTitle')) $id('chatTitle').textContent = window.dict[lang].chat_title || '';
    }

    // badge helper
    function badge(d){
      if(!d) return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300">‚Äî</span>`;
      if(+d>0) return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">‚ñ≤ +‚Çπ${d}</span>`;
      return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300">‚ñº ‚Çπ${Math.abs(d)}</span>`;
    }

    function renderRates(data,type){
      const body = $id('ratesTable').querySelector('tbody'); body.innerHTML = '';
      const rows = (data||[]).filter(r=>r.type===type);
      rows.forEach(r=>{
        const diff = (+r.current||0) - (+r.previous||0);
        const tr = document.createElement('tr'); tr.className="border-b last:border-0 dark:border-slate-800";
        tr.innerHTML = `<td class="py-2 pr-4 font-medium">${r.count}c</td>
                        <td class="py-2 pr-4">‚Çπ ${r.current}</td>
                        <td class="py-2 pr-4">${badge(diff)}</td>`;
        body.appendChild(tr);
      });
      $id('updatedAt').textContent = new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    function renderNews(data){
      const lang = localStorage.getItem('lang') || 'te';
      const list = (data||[]).filter(n=>n.lang===lang);
      const items = list.length ? list : (data||[]).slice(0,5);
      const row = items.map(n=>{
        const blink = String(n.tag||'').toLowerCase().includes('harvest') || String(n.tag||'').includes('‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç');
        const tagHtml = n.tag ? `<span class="px-2 py-0.5 rounded-full text-[11px] ${blink?'blink bg-sky-200':'bg-sky-100'}">${n.tag}</span>` : '';
        return `<div class="flex items-center gap-2 pr-4">${tagHtml}<span>${n.text||''}</span></div>`;
      }).join('');
      $id('newsTrackTop').innerHTML = (row||'') + (row||'') + (row||'');
      $id('newsUpdatedTop').textContent = new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    let PROMOS = [], promoIdx = 0, timer = null;
    function renderPromo(){
      const lang = localStorage.getItem('lang') || 'te';
      const track = $id('promoTrack'), dots = $id('promoDots');
      track.innerHTML = PROMOS.map((r,i)=>`
        <div class="promo-slide rounded-xl p-4 bg-blue-50 dark:bg-slate-800/40 ${i===promoIdx?'active':''}">
          ${r.badge?`<span class="inline-block text-xs px-3 py-1 rounded-full bg-sky-200/70">${r.badge}</span>`:''}
          <h4 class="mt-3 text-lg font-semibold">${lang==='te'?(r.title_te||r.title_en):(r.title_en||r.title_te)}</h4>
          <p class="text-slate-600 dark:text-slate-300">${lang==='te'?(r.desc_te||r.desc_en):(r.desc_en||r.desc_te)}</p>
        </div>`).join('');
      dots.innerHTML = PROMOS.map((_,i)=>`<button class="promo-dot ${i===promoIdx?'active':''}" data-i="${i}"></button>`).join('');
      dots.querySelectorAll('button').forEach(b=>b.onclick=()=>{promoIdx=+b.dataset.i;renderPromo();startPromo();});
    }
    function startPromo(){ if(timer) clearInterval(timer); if(PROMOS.length>0) timer = setInterval(()=>{ promoIdx=(promoIdx+1)%PROMOS.length; renderPromo(); },6000); }

    /* ---------------- Chat (data-driven & language specific) ---------------- */
    function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

    function appendUserMessage(text){
      const div = document.createElement('div'); div.className='msg user'; div.innerText=text;
      $id('chatMessages').appendChild(div); $id('chatMessages').scrollTop = $id('chatMessages').scrollHeight;
    }
    function appendBotMessage(text){
      const lang = localStorage.getItem('lang')||'te';
      const div = document.createElement('div'); div.className='msg bot';
      // single-language reply: put reply in reply-te class for styling consistency
      const cls = (lang==='en') ? 'reply-en' : 'reply-te';
      div.innerHTML = `<div class="${cls}">${escapeHtml(text)}</div>`;
      $id('chatMessages').appendChild(div); $id('chatMessages').scrollTop = $id('chatMessages').scrollHeight;
    }

    function makeReply(lang, key, payload){
      payload = payload || {};
      if(lang === 'en'){
        switch(key){
          case 'rates': return buildRatesSummary('en', payload);
          case 'news': return buildNewsSummary('en');
          case 'promo': return buildPromoSummary('en');
          case 'contact': return window.dict.en.chat_reply_contact.replace('%PHONE%', ADMIN_CONTACT_PHONE).replace('%EMAIL%', ADMIN_CONTACT_EMAIL);
          case 'aerator': return window.dict.en.chat_reply_aerator;
          case 'history': return window.dict.en.chat_reply_history;
          default: return window.dict.en.chat_reply_default;
        }
      } else {
        switch(key){
          case 'rates': return buildRatesSummary('te', payload);
          case 'news': return buildNewsSummary('te');
          case 'promo': return buildPromoSummary('te');
          case 'contact': return window.dict.te.chat_reply_contact.replace('%PHONE%', ADMIN_CONTACT_PHONE).replace('%EMAIL%', ADMIN_CONTACT_EMAIL);
          case 'aerator': return window.dict.te.chat_reply_aerator;
          case 'history': return window.dict.te.chat_reply_history;
          default: return window.dict.te.chat_reply_default;
        }
      }
    }

    function buildRatesSummary(lang, {type}){
      const rates = window.APP_DATA.rates || [];
      const rows = rates.filter(r=>r.type===type);
      if(!rows.length) return (lang==='en') ? 'No rates available.' : '‡∞ß‡∞∞‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞µ‡±Å.';
      const top = rows.slice(0,6);
      if(lang==='en'){
        let out = `Current ${type} rates: `;
        out += top.map(r => `${r.count}c = ‚Çπ${r.current}`).join(', ');
        out += `.`;
        return out;
      } else {
        let out = `${type} ‡∞ß‡∞∞‡∞≤‡±Å: `;
        out += top.map(r => `${r.count}c = ‚Çπ${r.current}`).join(', ');
        out += `.`;
        return out;
      }
    }

    function buildNewsSummary(lang){
      const news = window.APP_DATA.news || []; const langNow = localStorage.getItem('lang')||'te';
      const list = news.filter(n=>n.lang===langNow).slice(0,3);
      if(!list.length) return (lang==='en') ? 'No news available.' : '‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞µ‡±Å.';
      return (lang==='en' ? 'Latest: ' : '‡∞§‡∞æ‡∞ú‡∞æ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å: ') + list.map(n=>n.text).join(' | ');
    }

    function buildPromoSummary(lang){
      const promos = window.APP_DATA.promos || [];
      if(!promos.length) return (lang==='en') ? 'No promotions.' : '‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã‡∞∑‡∞®‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞µ‡±Å.';
      const p = promos[0];
      return (lang==='en') ? `${p.title_en||p.title_te} ‚Äî ${p.desc_en||''}` : `${p.title_te||p.title_en} ‚Äî ${p.desc_te||''}`;
    }

    function injectInitialGreeting(){
      const lang = localStorage.getItem('lang')||'te';
      const greeting = (lang==='en') ? window.dict.en.chat_greeting : window.dict.te.chat_greeting;
      appendBotMessage(greeting);
    }

    function botReply(userText){
      const lang = localStorage.getItem('lang')||'te';
      const t = (userText||'').toLowerCase();

      // contact
      const contactKeywords = ['contact','phone','email','number','‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞™‡±Å‡∞≤‡±Å','‡∞´‡±ã‡∞®‡±ç','‡∞®‡∞Æ‡±ç‡∞¨‡∞∞‡±ç','‡∞á‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞≤‡±ç'];
      if(contactKeywords.some(k=>t.includes(k))){
        appendBotMessage(makeReply(lang,'contact')); return;
      }

      // history
      const historyKeys = ['history','‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞','history:','‡∞π‡∞ø‡∞∏‡±ç‡∞ü‡∞∞‡±Ä'];
      if(historyKeys.some(k=>t.includes(k))){ appendBotMessage(makeReply(lang,'history')); return; }

      // aerator
      const aerKeys = ['aerator','‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç','‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç‡∞≤‡±Å'];
      if(aerKeys.some(k=>t.includes(k))){ appendBotMessage(makeReply(lang,'aerator')); return; }

      // news
      const newsKeys = ['news','‡∞µ‡∞æ‡∞∞‡±ç‡∞§','flash','‡∞§‡∞æ‡∞ú‡∞æ'];
      if(newsKeys.some(k=>t.includes(k))){ appendBotMessage(makeReply(lang,'news')); return; }

      // promo
      const promoKeys = ['promo','promotion','‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã','‡∞°‡∞ø‡∞∏‡±ç‡∞ï‡±å‡∞Ç‡∞ü‡±ç','offer'];
      if(promoKeys.some(k=>t.includes(k))){ appendBotMessage(makeReply(lang,'promo')); return; }

      // rates / price: check for numbers like 100c or words 'rate'/'‡∞ß‡∞∞'
      const rateKeys = ['rate','price','‡∞ß‡∞∞','rates','price of','‡∞ß‡∞∞‡∞≤'];
      // detect specific count like '100c' or '100 c' or '100'
      let askedForCount = null;
      const countMatch = userText.match(/(\d{2,3})\s*c?/i);
      if(countMatch) askedForCount = countMatch[1] + 'c';

      if(rateKeys.some(k=>t.includes(k)) || askedForCount){
        const selectedType = $id('prawnType') ? $id('prawnType').value : 'Vannamei';
        if(askedForCount){
          const row = (window.APP_DATA.rates||[]).find(r=>r.type===selectedType && r.count===askedForCount);
          if(row){
            if(lang==='en') appendBotMessage(`Price for ${row.count}: ‚Çπ${row.current} (previous: ‚Çπ${row.previous || '‚Äî'})`);
            else appendBotMessage(`${row.count} ‡∞ß‡∞∞: ‚Çπ${row.current} (‡∞Æ‡±Å‡∞®‡±Å‡∞™‡∞ü‡∞ø: ‚Çπ${row.previous || '‚Äî'})`);
            return;
          }
        }
        appendBotMessage(makeReply(lang,'rates',{type: selectedType}));
        return;
      }

      // fallback
      if((userText||'').trim().length < 3){ appendBotMessage((lang==='en')?window.dict.en.chat_reply_default:window.dict.te.chat_reply_default); return; }
      appendBotMessage((lang==='en')?window.dict.en.chat_reply_default:window.dict.te.chat_reply_default);
    }

    /* keyboard handling for mobile */
    function enableChatViewportSync(){
      const panel = $id('chatPanel'), btn = $id('openChat');
      if(!panel || !btn) return;
      let baseInner = window.innerHeight;
      function adjust(){
        try{
          if(window.visualViewport){
            const vv = window.visualViewport; const offset = Math.max(0, baseInner - vv.height);
            panel.style.bottom = `calc(${90 + offset}px + env(safe-area-inset-bottom))`;
            btn.style.bottom = `calc(${90 + offset}px + env(safe-area-inset-bottom))`;
            if(window.innerWidth <= 420) btn.style.bottom = `calc(${110 + offset}px + env(safe-area-inset-bottom))`;
          } else {
            const diff = Math.max(0, baseInner - window.innerHeight);
            panel.style.bottom = `calc(${90 + diff}px + env(safe-area-inset-bottom))`;
            btn.style.bottom = `calc(${90 + diff}px + env(safe-area-inset-bottom))`;
            if(window.innerWidth <= 420) btn.style.bottom = `calc(${110 + diff}px + env(safe-area-inset-bottom))`;
          }
        }catch(e){}
      }
      if(window.visualViewport) window.visualViewport.addEventListener('resize', adjust);
      window.addEventListener('resize', adjust);
      window.addEventListener('orientationchange', ()=>{ baseInner = window.innerHeight; setTimeout(adjust,300); });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      // language default
      if(!localStorage.getItem('lang')) localStorage.setItem('lang','te');
      applyI18n();

      // theme init
      const saved = localStorage.getItem('theme');
      if(saved==='dark' || (!saved && matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');

      // theme toggle
      $id('themeToggle').onclick = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      };

      // load CSVs (if exists) and store globally
      const rates = await loadCSV('data/rates.csv'); window.APP_DATA.rates = rates || [];
      const NEWS = await loadCSV('data/news.csv'); window.APP_DATA.news = NEWS || [];
      PROMOS = await loadCSV('data/promotions.csv'); window.APP_DATA.promos = PROMOS || [];

      // fill type options
      function fillTypeOptions(){
        const lang = localStorage.getItem('lang')||'te';
        $id('prawnType').innerHTML = `<option value="Vannamei">${window.dict[lang].type_van || 'Vannamei'}</option><option value="Tiger">${window.dict[lang].type_tig || 'Tiger'}</option>`;
      }
      fillTypeOptions();
      $id('prawnType').onchange = ()=> renderRates(window.APP_DATA.rates, $id('prawnType').value);
      renderRates(window.APP_DATA.rates, "Vannamei");
      renderNews(window.APP_DATA.news); renderPromo(); startPromo();

      // language change wire
      $id('langSel').value = localStorage.getItem('lang') || 'te';
      $id('langSel').onchange = e => {
        localStorage.setItem('lang', e.target.value);
        applyI18n(); fillTypeOptions(); renderRates(window.APP_DATA.rates,$id('prawnType').value); renderNews(window.APP_DATA.news); renderPromo();
      };

      // chat wiring
      const openChat = $id('openChat'), chatPanel = $id('chatPanel'), closeChat = $id('closeChat'), sendBtn = $id('sendBtn'), chatInput = $id('chatInput');
      injectInitialGreeting();

      openChat.addEventListener('click', ()=>{
        chatPanel.classList.add('open'); chatPanel.setAttribute('aria-hidden','false'); applyI18n();
        setTimeout(()=>{ if(chatInput) chatInput.focus(); },140);
      });
      closeChat.addEventListener('click', ()=>{ chatPanel.classList.remove('open'); chatPanel.setAttribute('aria-hidden','true'); openChat.focus(); });
      sendBtn.addEventListener('click', ()=>{ const txt = chatInput.value.trim(); if(!txt) return; appendUserMessage(txt); chatInput.value=''; botReply(txt); });
      chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });
      document.addEventListener('keydown', e=>{ if(e.key==='Escape' && chatPanel.classList.contains('open')){ chatPanel.classList.remove('open'); chatPanel.setAttribute('aria-hidden','true'); openChat.focus(); }});

      // viewport sync for mobile keyboard
      enableChatViewportSync();

      // ensure modules visible (defensive)
      document.querySelectorAll('.module').forEach(el => { el.style.display = 'block'; el.style.visibility = 'visible'; el.style.opacity = '1'; });

      // theme aria
      function updateThemeAria(){ const isDark = document.documentElement.classList.contains('dark'); $id('themeToggle').setAttribute('aria-pressed', isDark ? 'true' : 'false'); }
      updateThemeAria();
      const obs = new MutationObserver(updateThemeAria);
      obs.observe(document.documentElement, { attributes:true, attributeFilter:['class'] });
    });
  </script>
</body>
</html>
