<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aquaculture A‚ÄìZ ‚Ä¢ Home</title>

  <!-- Fonts: include Telugu font for better Telugu typing/rendering -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>

  <style>
    :root { --chat-accent: #0b6b6b; --muted: #6b7280; }
    html{scroll-behavior:smooth}
    body{font-family: "Noto Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Telugu", "Noto Sans Gujarati", "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#dbeafe 0%,#e0f2fe 50%,#f0fdf4 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .dark body{background:linear-gradient(135deg,#0f172a 0%,#082f49 50%,#14532d 100%)}
    .navbtn{border:1px solid rgb(226,232,240);padding:.55rem .9rem;border-radius:.75rem;background:#fff;text-align:center;font-weight:700;font-size:1rem;white-space:nowrap;}
    @media (min-width:640px){ .navbtn{font-size:.95rem;padding:.6rem 1rem} }
    .dark .navbtn{background:#0b1220;border-color:#1f2937}

    /* ticker */
    .ticker{overflow:hidden;mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent)}
    .ticker-track{display:flex;gap:24px;white-space:nowrap;min-width:max-content;animation:ticker 35s linear infinite;align-items:center}
    .ticker-track > div{display:inline-flex;align-items:center;gap:12px;color:inherit;font-weight:600}
    .ticker-track .tag { padding:.18rem .5rem;border-radius:9999px;font-size:11px; display:inline-flex; align-items:center; justify-content:center; white-space:nowrap; }
    @keyframes ticker{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    @media (max-width:640px){.ticker{mask-image:none;-webkit-mask-image:none}.ticker-track{gap:16px;animation-duration:45s}}
    @keyframes blink{0%,100%{opacity:1;background-color:#facc15;color:#111827}50%{opacity:1;background-color:#dc2626;color:#fff}}
    .blink{animation:blink 1.2s infinite}

    .promo-dot{height:.5rem;width:.5rem;border-radius:9999px;border:1px solid currentColor;opacity:.5}
    .promo-dot.active{opacity:1;background:currentColor}
    .promo-slide{display:none}
    .promo-slide.active{display:block}

    /* CHAT styles */
    .chat-btn { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); width: 56px; height: 56px; border-radius: 50%; background: var(--chat-accent); color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 18px rgba(11,107,107,0.18); border: none; z-index: 1200; font-size: 20px; }
    /* On desktop keep as small floating panel; on mobile expand to near-full width but not full screen */
    .chat-panel { position: fixed; right: 16px; bottom: 86px; width: 360px; max-width: calc(100% - 32px); height: 52vh; max-height: 520px; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); display: none; flex-direction: column; overflow: hidden; z-index: 1199; transition: transform .18s ease, opacity .18s ease; }
    .chat-panel.open { display: flex; transform: translateY(0); opacity:1; }
    /* mobile behaviour: place panel centered and slightly taller above keyboard */
    @media (max-width: 480px) {
      .chat-panel { right: 8px; left: 8px; bottom: env(safe-area-inset-bottom); width: auto; max-width: none; height: calc(100vh - 120px); max-height: calc(100vh - 120px); border-radius: 12px 12px 0 0; }
    }

    .chat-header { padding: 10px 12px; border-bottom: 1px solid #eee; display:flex;align-items:center;justify-content:space-between; gap:8px; }
    .chat-title { font-weight:700; font-size:15px; color: #064646 }
    .chat-messages { flex:1; padding:10px; overflow:auto; display:flex;flex-direction:column; gap:10px; background:#fbfbfb; }
    .msg { max-width:78%; padding:9px 12px; border-radius:12px; font-size:14px; line-height:1.35; word-break:break-word; }
    .msg.user { align-self:flex-end; background:var(--chat-accent); color:#fff; border-bottom-right-radius:6px; }
    .msg.bot { align-self:flex-start; background:#fff; color:#111; border:1px solid #eee; }
    .reply-en { font-weight:700; margin-bottom:6px; font-size:14px; }
    .reply-te { color: #475569; font-size:13px; opacity:0.95; }

    .chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; align-items:center; background:transparent; }
    .chat-input input { flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:15px; background:#fff; color:inherit; min-height:42px; }
    .chat-input button { padding:10px 14px;border-radius:10px;border:none;background:var(--chat-accent);color:#fff;font-weight:700; min-width:72px; }
    @media (max-width:480px) {
      .chat-input input { font-size:16px; min-height:46px; }
      .reply-en { font-size:15px; }
      .reply-te { font-size:14px; }
    }

    /* Dark mode chat tweaks */
    .dark .chat-panel { background: linear-gradient(180deg,#071424 0%,#071a1f 100%); color: #e6eef3; box-shadow: 0 12px 30px rgba(2,8,23,0.6); border: 1px solid rgba(255,255,255,0.03); }
    .dark .chat-header { border-bottom-color: rgba(255,255,255,0.04); }
    .dark .chat-title { color: #cfe8e6; }
    .dark .chat-messages { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .dark .msg.bot { background: rgba(255,255,255,0.03); color: #e6eef3; border: 1px solid rgba(255,255,255,0.04); }
    .dark .msg.user { background: linear-gradient(180deg,#0b6b6b,#085e5e); color: #fff; }
    .dark .reply-te { color: #cbd5e1; opacity: 0.95; }
    .dark .chat-input { border-top-color: rgba(255,255,255,0.04); }
    .dark .chat-input input { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.06); color: #e6eef3; }

    /* Ensure ticker text not pure white in dark, but readable */
    .dark .ticker-track > div { color: #e6eef3; opacity: 0.95; }
    .dark .ticker-track .tag { color: #031e22; background: rgba(255,255,255,0.06); padding:.18rem .5rem; border-radius:9999px; }

    /* hide aerator / small details per request - (section removed from HTML) */
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center">
      <div class="h-9 w-9 mr-1 relative">
        <img src="assets/logo.png" alt="Logo" class="h-9 w-9 object-contain block dark:hidden">
        <img src="assets/logo-dark.png" alt="Logo" class="h-9 w-9 object-contain hidden dark:block">
      </div>
      <h1 class="text-xl font-bold hidden sm:inline">Aquaculture A‚ÄìZ</h1>
      <h1 class="text-xl font-bold sm:hidden mr-14 sm:mr-0">Aquaa A‚ÄìZ</h1>
      <nav class="hidden sm:flex gap-2 flex-1 justify-center">
        <a href="index.html" class="navbtn">üè† <span data-i18n="m_home">Home</span></a>
        <a href="harvest.html" class="navbtn">üöö <span data-i18n="t_harvest">Harvest</span></a>
        <a href="seeds.html" class="navbtn">ü¶ê <span data-i18n="t_seeds">Seeds</span></a>
        <a href="vendors.html" class="navbtn">üè™ <span data-i18n="t_dealers">Dealers</span></a>
        <a href="history.html" class="navbtn">üìú <span data-i18n="m_history">History</span></a>
      </nav>
      <div class="flex items-center gap-2 flex-none">
        <label for="langSel" class="text-sm text-slate-600 dark:text-slate-300 select-none">Ln</label>
        <select id="langSel" class="text-sm border rounded-md px-2 py-1 dark:bg-slate-900 dark:border-slate-700">
          <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
          <option value="en">English</option>
        </select>
        <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">üåô/‚òÄÔ∏è</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4 pb-36 sm:pb-4">
    <!-- MOBILE nav buttons -->
    <div class="flex sm:hidden gap-2 justify-around">
      <a href="harvest.html" class="navbtn flex-1 text-center">üöö <span data-i18n="t_harvest">Harvest</span></a>
      <a href="seeds.html" class="navbtn flex-1 text-center">ü¶ê <span data-i18n="t_seeds">Seeds</span></a>
      <a href="vendors.html" class="navbtn flex-1 text-center">üè™ <span data-i18n="t_dealers">Dealers</span></a>
    </div>

    <!-- Flash News -->
    <section class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">üì∞ <span data-i18n="flash_news">‡∞§‡∞æ‡∞ú‡∞æ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§</span></h3>
        <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200">Live</span>
      </div>
      <div class="mt-3 ticker"><div id="newsTrackTop" class="ticker-track"></div></div>
      <p class="text-xs text-slate-500 mt-2"><span data-i18n="updated">Updated</span>: <span id="newsUpdatedTop">‚Äî</span></p>
    </section>

    <!-- Rates + Promotions -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Rates -->
      <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold" data-i18n="snapshot">‡∞≤‡±à‡∞µ‡±ç ‡∞∏‡±ç‡∞®‡∞æ‡∞™‡±ç‚Äå‡∞∑‡∞æ‡∞ü‡±ç</h3>
          <p class="text-xs text-slate-500"><span data-i18n="updated">‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç</span>: <span id="updatedAt">‚Äî</span></p>
        </div>
        <div class="mt-3 flex items-center gap-3">
          <label for="prawnType" class="text-sm font-medium" data-i18n="lbl_type">‡∞∞‡∞ï‡∞Ç</label>
          <select id="prawnType" class="text-sm border rounded-md px-2 py-1 dark:bg-slate-800 dark:border-slate-600"></select>
        </div>
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm" id="ratesTable">
            <thead>
              <tr class="border-b dark:border-slate-800 text-slate-500">
                <th class="text-left py-2 pr-4" data-i18n="th_count">‡∞ï‡±å‡∞Ç‡∞ü‡±ç</th>
                <th class="text-left py-2 pr-4" data-i18n="th_price">‡∞ß‡∞∞ (‚Çπ/kg)</th>
                <th class="text-left py-2 pr-4" data-i18n="th_change">‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Promotions -->
      <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">üì£ <span data-i18n="promotions_title">‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã‡∞∑‡∞®‡±ç‡∞∏‡±ç</span></h3>
        </div>
        <div id="promoSlider" class="relative mt-3">
          <div id="promoTrack" class="overflow-hidden rounded-xl"></div>
          <div id="promoDots" class="mt-3 flex gap-2"></div>
        </div>
      </div>
    </section>

    <!-- removed Aerator section as requested -->

  </main>

  <!-- Chat: floating button + panel (bilingual replies) -->
  <button class="chat-btn" id="openChat" aria-label="Open chat">üí¨</button>

  <div class="chat-panel" id="chatPanel" role="dialog" aria-label="Chat with Aqua A-Z" aria-hidden="true">
    <div class="chat-header">
      <div class="chat-title" id="chatTitle" data-i18n="chat_title">‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç & ‡∞ö‡∞æ‡∞ü‡±ç</div>
      <button id="closeChat" aria-label="Close chat" style="background:none;border:none;font-size:18px;padding:6px;cursor:pointer">‚úï</button>
    </div>

    <div class="chat-messages" id="chatMessages" aria-live="polite">
      <!-- initial injected by JS -->
    </div>

    <div class="chat-input" role="form" aria-label="Chat input">
      <input id="chatInput" type="text" placeholder="‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø..." aria-label="Type a message" autocomplete="off" autocorrect="off" autocapitalize="sentences" enterkeyhint="send" />
      <button id="sendBtn" aria-label="Send message">Send</button>
    </div>
  </div>

  <script>
    // helpers
    const $id = s => document.getElementById(s);

    async function loadCSV(url){
      try {
        const res = await fetch(url, {cache:'no-store'});
        if (!res.ok) throw 0;
        const txt = await res.text();
        const lines = txt.trim().split(/\r?\n/);
        const headers = lines[0].split(',').map(h=>h.trim());
        return lines.slice(1).map(line => {
          const vals = line.split(',');
          const o = {};
          headers.forEach((h,i)=>o[h]=vals[i]);
          return o;
        });
      } catch(e) { return []; }
    }

    // i18n dictionary (flash_news changed to "‡∞§‡∞æ‡∞ú‡∞æ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§")
    window.dict = {
      en:{
        snapshot:"Live Snapshot",updated:"Updated",lbl_type:"Type",th_count:"Count",th_price:"Price (‚Çπ/kg)",th_change:"Change",
        promotions_title:"Promotions",m_home:"Home",m_history:"History",t_harvest:"Harvest",t_seeds:"Seeds",t_dealers:"Dealers",
        flash_news:"Flash News",
        type_van:"Vannamei",type_tig:"Tiger",
        chat_title:"Help & Chat",chat_greeting:"Hi! How can I help you today?",chat_greeting_te:"‡∞π‡∞æ‡∞Ø‡±ç! ‡∞®‡±á‡∞®‡±Å ‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å?",
        chat_placeholder:"Type a message...",chat_open_aria:"Open chat",chat_close_aria:"Close chat",
        chat_reply_default:"Sorry, I cannot perform that now; but I can help. Please give more details.",
        chat_reply_aerator:"What details about aerators do you need? Model, capacity, or services?",
        chat_reply_history:"History: latest updates are managed by site admin and shown here when available.",
        chat_more_info:"Please type a more detailed message."
      },
      te:{
        snapshot:"‡∞≤‡±à‡∞µ‡±ç ‡∞∏‡±ç‡∞®‡∞æ‡∞™‡±ç‚Äå‡∞∑‡∞æ‡∞ü‡±ç",updated:"‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç",lbl_type:"‡∞∞‡∞ï‡∞Ç",th_count:"‡∞ï‡±å‡∞Ç‡∞ü‡±ç",th_price:"‡∞ß‡∞∞ (‚Çπ/kg)",th_change:"‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å",
        promotions_title:"‡∞™‡±ç‡∞∞‡±ã‡∞Æ‡±ã‡∞∑‡∞®‡±ç‡∞∏‡±ç",m_home:"‡∞π‡±ã‡∞Æ‡±ç",m_history:"‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",t_harvest:"‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç",t_seeds:"‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç",t_dealers:"‡∞µ‡±Ü‡∞Ç‡∞°‡∞∞‡±ç‡∞≤‡±Å",
        flash_news:"‡∞§‡∞æ‡∞ú‡∞æ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§",
        type_van:"‡∞µ‡∞®‡±ç‡∞®‡∞æ‡∞Æ‡±Ä",type_tig:"‡∞ü‡±à‡∞ó‡∞∞‡±ç",
        chat_title:"‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç & ‡∞ö‡∞æ‡∞ü‡±ç",chat_greeting:"‡∞π‡∞æ‡∞Ø‡±ç! ‡∞®‡±á‡∞®‡±Å ‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å?",chat_greeting_te:"Hi! How can I help you today?",
        chat_placeholder:"‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞∞‡∞æ‡∞Ø‡∞Ç‡∞°‡∞ø...",chat_open_aria:"‡∞ö‡∞æ‡∞ü‡±ç ‡∞ì‡∞™‡±Ü‡∞®‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",chat_close_aria:"‡∞ö‡∞æ‡∞ü‡±ç ‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
        chat_reply_default:"‡∞ï‡±ç‡∞∑‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø, ‡∞®‡±á‡∞®‡±Å ‡∞¶‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞Ö‡∞Æ‡∞≤‡±Å ‡∞ö‡±á‡∞Ø‡∞≤‡±á‡∞®‡±Å; ‡∞ï‡∞æ‡∞®‡±Ä ‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞π‡∞æ‡∞Ø‡∞™‡∞°‡∞ó‡∞≤‡∞®‡±Å. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø.",
        chat_reply_aerator:"‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç‡∞≤ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞è‡∞Æ‡∞ø ‡∞§‡±Ü‡∞≤‡±Å‡∞∏‡±Å‡∞ï‡±ã‡∞µ‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å? ‡∞Æ‡±ã‡∞°‡∞≤‡±ç, ‡∞∏‡∞æ‡∞Æ‡∞∞‡±ç‡∞•‡±ç‡∞Ø‡∞Ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞∏‡±á‡∞µ‡∞≤‡±Å?",
        chat_reply_history:"‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞: ‡∞§‡∞æ‡∞ú‡∞æ ‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç‡∞∏‡±ç ‡∞∏‡±à‡∞ü‡±ç ‡∞Ö‡∞°‡±ç‡∞Æ‡∞ø‡∞®‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞π‡∞ø‡∞Ç‡∞™‡∞¨‡∞°‡∞ø ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ö‡±Ç‡∞™‡∞¨‡∞°‡∞§‡∞æ‡∞Ø‡∞ø.",
        chat_more_info:"‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞Ç‡∞ó‡∞æ ‡∞ü‡±à‡∞™‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø."
      }
    };

    function applyI18n(){
      const lang = localStorage.getItem('lang') || 'te';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.dataset.i18n;
        if(window.dict[lang] && window.dict[lang][k]) el.textContent = window.dict[lang][k];
      });
      // chat placeholders & aria
      const langNow = localStorage.getItem('lang') || 'te';
      if($id('chatInput')) {
        $id('chatInput').placeholder = window.dict[langNow]['chat_placeholder'] || '';
        // set input lang attribute so mobile keyboard may switch properly
        $id('chatInput').setAttribute('lang', langNow === 'te' ? 'te' : 'en');
      }
      if($id('openChat')) $id('openChat').setAttribute('aria-label', window.dict[langNow]['chat_open_aria'] || '');
      if($id('closeChat')) $id('closeChat').setAttribute('aria-label', window.dict[langNow]['chat_close_aria'] || '');
      if($id('chatTitle')) $id('chatTitle').textContent = window.dict[langNow]['chat_title'] || '';
    }

    // badge helper
    function badge(d){
      if(d===null) return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300">‚Äî</span>`;
      if(d>0) return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">‚ñ≤ +‚Çπ${d}</span>`;
      if(d<0) return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300">‚ñº ‚Çπ${Math.abs(d)}</span>`;
      return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300">‚Äî</span>`;
    }

    function renderRates(data,type){
      const body = $id('ratesTable').querySelector('tbody');
      body.innerHTML='';
      const rows = data.filter(r=>r.type===type);
      rows.forEach(r=>{
        const diff = (+r.current||0)-(+r.previous||0);
        const tr = document.createElement('tr');
        tr.className="border-b last:border-0 dark:border-slate-800";
        tr.innerHTML=`<td class="py-2 pr-4 font-medium">${r.count}c</td>
                      <td class="py-2 pr-4">‚Çπ ${r.current}</td>
                      <td class="py-2 pr-4">${badge(diff)}</td>`;
        body.appendChild(tr);
      });
      $id('updatedAt').textContent = new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    // improved renderNews with dark-friendly tags & reading text and language matching
    function renderNews(data){
      const lang = localStorage.getItem('lang') || 'te';
      const list = data.filter(n => (n.lang && n.lang === lang) || !n.lang);
      const isDark = document.documentElement.classList.contains('dark');
      const row = list.map(n=>{
        const tagText = n.tag || '‚Äî';
        const lowerTag = String(tagText).toLowerCase();
        const blink = /harvest|‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç|‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç/i.test(lowerTag) || (n.tag && /‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç/i.test(n.tag));
        const tagClass = isDark ? 'tag dark-tag' : 'tag';
        const textVal = (lang === 'te') ? (n.text_te || n.text_en || n.text || '') : (n.text_en || n.text_te || n.text || '');
        // pick tag inline style for light mode to ensure visibility
        const tagInline = !isDark ? (blink ? 'style="background:#f0ab00;color:#081126"' : 'style="background:#bae6fd;color:#022c39"') : '';
        return `<div class="pr-4" style="display:inline-flex;align-items:center;gap:12px">
                  <span class="${tagClass}" ${tagInline}>${escapeHtml(tagText)}</span>
                  <span style="display:inline-block;font-weight:600;opacity:0.95;color:inherit">${escapeHtml(textVal)}</span>
                </div>`;
      }).join('');
      $id('newsTrackTop').innerHTML = row ? (row + row + row) : '<div class="pr-4">No flash news available</div>';
      $id('newsUpdatedTop').textContent = new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

    let PROMOS=[], promoIdx=0, timer=null;
    function renderPromo(){
      const lang = localStorage.getItem('lang') || 'te';
      const track = $id('promoTrack'), dots = $id('promoDots');
      track.innerHTML = PROMOS.map((r,i)=>`
        <div class="promo-slide rounded-xl p-4 bg-blue-50 dark:bg-slate-800/40 ${i===promoIdx?'active':''}">
          ${r.badge?`<span class="inline-block text-xs px-3 py-1 rounded-full bg-sky-200/70">${r.badge}</span>`:''}
          <h4 class="mt-3 text-lg font-semibold">${lang==='te' ? (r.title_te||r.title_en) : (r.title_en||r.title_te)}</h4>
          <p class="text-slate-600 dark:text-slate-300">${lang==='te' ? (r.desc_te||r.desc_en) : (r.desc_en||r.desc_te)}</p>
        </div>`).join('');
      dots.innerHTML = PROMOS.map((_,i)=>`<button class="promo-dot ${i===promoIdx?'active':''}" data-i="${i}"></button>`).join('');
      dots.querySelectorAll('button').forEach(b=>b.onclick=()=>{ promoIdx=+b.dataset.i; renderPromo(); startPromo(); });
    }
    function startPromo(){ if(timer) clearInterval(timer); if(PROMOS.length>0) timer = setInterval(()=>{ promoIdx=(promoIdx+1)%PROMOS.length; renderPromo(); }, 6000); }

    /* ---------------- Chat (bilingual replies) ---------------- */
    function appendUserMessage(text){
      const div = document.createElement('div'); div.className='msg user'; div.innerText = text; $id('chatMessages').appendChild(div);
      $id('chatMessages').scrollTop = $id('chatMessages').scrollHeight;
    }
    function appendBotMessage(en, te){
      const div = document.createElement('div'); div.className='msg bot';
      div.innerHTML = `<div class="reply-en">${escapeHtml(en)}</div><div class="reply-te">${escapeHtml(te)}</div>`;
      $id('chatMessages').appendChild(div); $id('chatMessages').scrollTop = $id('chatMessages').scrollHeight;
    }

    function injectInitialGreeting(){
      const enGreeting = window.dict.en.chat_greeting || 'Hi! How can I help you today?';
      const teGreeting = window.dict.te.chat_greeting || '‡∞π‡∞æ‡∞Ø‡±ç! ‡∞®‡±á‡∞®‡±Å ‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å?';
      appendBotMessage(enGreeting, teGreeting);
    }

    function botReply(userText){
      const t = (userText||'').toLowerCase();
      let en = window.dict.en.chat_reply_default, te = window.dict.te.chat_reply_default;
      if(t.includes('aerator')||t.includes('‡∞é‡∞∞‡±á‡∞ü‡∞∞‡±ç')){ en = window.dict.en.chat_reply_aerator; te = window.dict.te.chat_reply_aerator; }
      else if(t.includes('history')||t.includes('‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞')){ en = window.dict.en.chat_reply_history; te = window.dict.te.chat_reply_history; }
      else if((userText||'').trim().length < 3){ en = window.dict.en.chat_more_info; te = window.dict.te.chat_more_info; }
      setTimeout(()=>appendBotMessage(en, te), 420);
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      if(!localStorage.getItem('lang')) localStorage.setItem('lang','te');
      applyI18n();

      // theme: preserve user preference
      const saved = localStorage.getItem('theme');
      if(saved === 'dark' || (!saved && matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
      $id('themeToggle').onclick = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); renderNews([]); /* re-render news for tag color */ };

      // load CSVs (if present)
      const rates = await loadCSV('data/rates.csv');
      const NEWS = await loadCSV('data/news.csv');
      PROMOS = await loadCSV('data/promotions.csv');

      // prawn type options
      function fillTypeOptions(){ const lang = localStorage.getItem('lang')||'te'; $id('prawnType').innerHTML = `<option value="Vannamei">${window.dict[lang].type_van}</option><option value="Tiger">${window.dict[lang].type_tig}</option>`; }
      fillTypeOptions();
      $id('prawnType').onchange = ()=>renderRates(rates, $id('prawnType').value);
      renderRates(rates, "Vannamei");
      renderNews(NEWS); renderPromo(); startPromo();

      // language change
      $id('langSel').value = localStorage.getItem('lang') || 'te';
      $id('langSel').onchange = e => {
        localStorage.setItem('lang', e.target.value);
        applyI18n(); fillTypeOptions(); renderRates(rates, $id('prawnType').value); renderNews(NEWS); renderPromo();
      };

      // CHAT wiring & mobile keyboard adjustments
      const openChat = $id('openChat'), chatPanel = $id('chatPanel'), closeChat = $id('closeChat'), sendBtn = $id('sendBtn'), chatInput = $id('chatInput');
      injectInitialGreeting();

      openChat.addEventListener('click', ()=>{
        chatPanel.classList.add('open');
        chatPanel.setAttribute('aria-hidden','false');
        applyI18n();
        // small delay then focus so mobile opens keyboard
        setTimeout(()=>{ chatInput.focus(); scrollChatToBottom(); }, 120);
      });

      closeChat.addEventListener('click', ()=>{
        chatPanel.classList.remove('open');
        chatPanel.setAttribute('aria-hidden','true');
        openChat.focus();
      });

      sendBtn.addEventListener('click', ()=>{
        const txt = chatInput.value.trim();
        if(!txt) return;
        appendUserMessage(txt);
        chatInput.value = '';
        botReply(txt);
        // keep focus for quick replies on mobile
        setTimeout(()=>{ chatInput.focus(); }, 250);
      });

      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); }
      });

      // Ensure chat messages area stays visible when keyboard opens on mobile:
      // when input receives focus, give the messages container some breathing room
      chatInput.addEventListener('focus', ()=>{ setTimeout(scrollChatToBottom, 200); });
      function scrollChatToBottom(){ try{ $id('chatMessages').scrollTop = $id('chatMessages').scrollHeight; } catch(e){} }

      // handle ESC to close chat
      document.addEventListener('keydown', e=>{ if(e.key === 'Escape' && chatPanel.classList.contains('open')){ chatPanel.classList.remove('open'); chatPanel.setAttribute('aria-hidden','true'); openChat.focus(); }});

      // small improvement: if lang is te, hint mobile to use telugu keyboard by setting input lang attribute
      const langNow = localStorage.getItem('lang') || 'te';
      if(chatInput) chatInput.setAttribute('lang', langNow === 'te' ? 'te' : 'en');
    });
  </script>
</body>
</html>
